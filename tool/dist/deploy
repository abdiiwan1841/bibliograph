#!/usr/bin/env bash

# get environment variables that override the defaults
DEPLOY_ENV_FILE=$1
source $DEPLOY_ENV_FILE

DEPLOY_DIR=${DEPLOY_DIR:-/var/www/bibliograph}
DEPLOY_CONFIG_DIR=${DEPLOY_CONFIG_DIR:-$DEPLOY_DIR/config}
DIST_DIR=$(pwd)/dist

if [[ "$DEPLOY_HOST" == "" ]]; then
    echo "Usage:"
    echo "deploy.sh <server> <path> <config directory>"
    echo "   - name of the deployment server as configured in .ssh/config"
    echo "     or 'local' if target is on local filesystem"
    echo "   - path on that server (optional, default: /var/www/bibliograph)"
    echo "   - path to the directory where config files should be stored (optional)"
    exit 0
fi

echo
echo "This will deploy the code in 'dist' to the following target:"
echo "   Server:           $DEPLOY_HOST"
echo "   Path:             $DEPLOY_DIR"
echo "   Config directory: $DEPLOY_CONFIG_DIR"

if [ "$DEPLOY_NONINTERACTIVE" != true ]; then
  read -r -p "Proceed? [y/N] " response
  case "$response" in
    [yY][eE][sS]|[yY])
        # pass
        ;;
    *)
        echo "Aborted."
        exit 0;
        ;;
  esac
fi

shopt -s dotglob
if [ "$DEPLOY_HOST" == "local" ]; then
  mkdir -p $DEPLOY_DIR
  if [ "$DEPLOY_CLEAN" == true ]; then
    echo ">>> Cleaning up $DEPLOY_DIR ..."
    sudo rm -rf $DEPLOY_DIR/*
    sudo mysql -e 'drop database if exists bibliograph; create database bibliograph;'
  fi
  echo ">>> Copying files to $DEPLOY_DIR ..."
  cp -rf $DIST_DIR/* $DEPLOY_DIR
  chmod -R 0777 $DEPLOY_DIR/server/runtime
else
  ssh $DEPLOY_HOST "mkdir -p $DEPLOY_DIR"
  if [ "$DEPLOY_CLEAN" == true ]; then
    echo ">>> Cleaning up $DEPLOY_DIR ..."
    ssh $DEPLOY_HOST "rm -rf $DEPLOY_DIR/*"
    ssh $DEPLOY_HOST "mysql -e 'drop database if exists bibliograph; create database bibliograph;'"
  fi
  echo ">>> Syncing files with $DEPLOY_HOST:$DEPLOY_DIR ..."
  rsync -azpr $DIST_DIR/* $DEPLOY_HOST:$DEPLOY_DIR
  if [ "$DEPLOY_CONFIG_DIR" != "$DEPLOY_DIR/config" ]; then
    ssh $DEPLOY_HOST "mv $DEPLOY_DIR/config $DEPLOY_CONFIG_DIR"
    ssh $DEPLOY_HOST "sed -i 's/__DIR__ \\. \\\"\\/config\\\"/$DEPLOY_CONFIG_DIR/' $DEPLOY_DIR/server.php"
  fi
  ssh $DEPLOY_HOST "chmod -R 0777 $DEPLOY_DIR/server/runtime"
fi
echo "Done."
